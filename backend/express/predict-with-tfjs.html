<!DOCTYPE html>
<html>
  <head>
    <title>BadmintonTutor</title>
    <link rel="stylesheet" href="./style.css" />
    <link rel="icon" type="image/x-icon" href="./favicon.ico" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
      integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
  </head>

  <body>
    <div class="base-page__inner-margin">
      <h2 class="base-page__heading-short">
        <span class="fa-stack mr-4" id="backButton">
          <i class="fa-solid fa-circle fa-stack-2x"></i>
          <i class="fa-solid fa-chevron-left fa-stack-1x fa-inverse"></i> </span
        >Badminton Tutor
      </h2>
      <!-- <button id="updateDBButton">updateAccuracyDB</button> -->
      <small id="msg"></small><br />
      <small>Make sure your full body is in the camera</small><br />

      <div class="flex">
        <button type="button" id="startButton" class="mt-10 mr-3">
          <i class="fas fa-circle-play fa-3x"></i>
        </button>
        <button
          type="button"
          style="display: none"
          id="continueButton"
          class="mt-10 mr-3"
        >
          <i class="fas fa-circle-play fa-3x"></i>
        </button>
        <button
          type="button"
          style="display: none"
          id="pauseButton"
          class="mt-10 mr-3"
        >
          <i class="fas fa-circle-pause fa-3x"></i>
        </button>
        <button
          type="button"
          style="display: none"
          id="stopButton"
          class="mt-10 mr-3"
        >
          <i class="fas fa-3x fa-circle-stop"></i>
        </button>
      </div>

      <div class="flex flex-row gap-x-16 mt-10">
        <canvas id="canvas"></canvas>
        <img id="correctPostImage" src="https://placehold.co/350x220" alt="" />
        <h1 id="currentPose" class="text-6xl"></h1>
      </div>
      <div id="label-container"></div>
      <ol id="feedbacks"></ol>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/pose@0.8/dist/teachablemachine-pose.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <script type="module">
      import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";
      import {
        init,
        clickStart,
        clickCont,
        clickPause,
        clickStop,
        backToApp,
      } from "./predict.js";

      async function generateFeedback(pose, correctJsonString) {
        const incorrectJson = JSON.stringify(pose).replaceAll("'", "\"");
        const correctJson = JSON.parse(correctJsonString.replaceAll("'", "\""));
        console.log("Generating feedback...", {pose, correctJsonString});
        const genAI = new GoogleGenerativeAI("AIzaSyAgtqxNm9C9fH1FmIjmBgTMSz5i1xJJgAU");
        const model = genAI.getGenerativeModel({ model: "gemini-pro" });
        const prompt = `provided the correct pose's coordinates: ${correctJson}. provided the incorrect pose's coordinates: ${incorrectJson}. Teach and instruct the person with incorrect pose to adjust his body in 3 sentence. you dont have to show the adjusted arrays`;

        const result = await model.generateContent(prompt);
        const response = await result.response;
        const feedback = response.text();
        attachFeedback(feedback);
        speak(feedback);
      }

      function attachFeedback(feedback) {
        const feedbackContainer = document.createElement("li");
        feedbackContainer.innerHTML = feedback;
        document.getElementById("feedbacks").appendChild(feedbackContainer);
      }

      document.querySelector("#startButton").addEventListener("click", () => {
        init();
        clickStart();
      });
      document
        .querySelector("#continueButton")
        .addEventListener("click", clickCont);
      document
        .querySelector("#pauseButton")
        .addEventListener("click", clickPause);
      document
        .querySelector("#stopButton")
        .addEventListener("click", clickStop);
      document
        .querySelector("#backButton")
        .addEventListener("click", backToApp);
      window.generateFeedback = generateFeedback;
    </script>
    <script>
      /*
       * Check for browser support
       */
      var supportMsg = document.getElementById("msg");

      if ("speechSynthesis" in window) {
        supportMsg.innerHTML =
          "Your browser <strong>supports</strong> speech synthesis.";
      } else {
        supportMsg.innerHTML =
          'Sorry your browser <strong>does not support</strong> speech synthesis.<br>Try this in <a href="https://www.google.co.uk/intl/en/chrome/browser/canary.html">Chrome Canary</a>.';
        supportMsg.classList.add("not-supported");
      }

      window.speechSynthesis.cancel();
      const speechSynthesis = window.speechSynthesis;
      var voices = null;

      window.speechSynthesis.onvoiceschanged = async (e) => {
        voices = await speechSynthesis.getVoices();
      };

      function speak(text) {
        var msg = new SpeechSynthesisUtterance(text);
        msg.lang = "en-US";
        msg.volume = parseFloat(1);
        msg.rate = parseFloat(1);
        msg.pitch = parseFloat(1);
        msg.voice = voices[0];
        window.speechSynthesis.speak(msg);
      }
    </script>
    <style>
      img {
        height: 270px;
        width: 480px;
      }
    </style>
  </body>
</html>
